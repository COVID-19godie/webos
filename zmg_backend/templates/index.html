<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZMG Cloud OS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- ç™»å½•æ£€æŸ¥æ ·å¼ -->
    <style>
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        
        .login-prompt {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .login-prompt h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .login-btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .login-btn:hover {
            background: #0056d6;
        }
    </style>
    
    <style>
        /* ================= æ ¸å¿ƒå˜é‡ä¸é‡ç½® ================= */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --backdrop-blur: blur(12px);
            --accent-color: #007aff;
            --text-color: #333;
            --win-header-h: 40px;
        }

        * { box-sizing: border-box; user-select: none; outline: none; }
        body { 
            margin: 0; overflow: hidden; font-family: "Segoe UI", "Microsoft YaHei", sans-serif; 
            background-color: #333;
            background-size: cover; background-position: center; transition: background 0.5s;
        }

        /* åŠ¨æ€å£çº¸é®ç½© (è®©æ–‡å­—æ›´æ¸…æ™°) */
        body::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.1); z-index: 0; pointer-events: none;
        }

        /* ================= æ¡Œé¢å›¾æ ‡ç³»ç»Ÿ ================= */
        #desktop { position: fixed; top: 0; left: 0; width: 100%; height: calc(100% - 80px); padding: 10px; z-index: 1; }
        .icon-grid { 
            display: flex; flex-direction: column; flex-wrap: wrap; 
            height: 100%; align-content: flex-start; gap: 15px; 
        }
        
        .icon {
            width: 90px; display: flex; flex-direction: column; align-items: center; 
            cursor: pointer; padding: 5px; border-radius: 8px; transition: 0.2s; position: relative;
        }
        .icon:hover { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); }
        .icon:active { transform: scale(0.95); }
        
        .icon-body {
            width: 64px; height: 64px; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.9); border-radius: 14px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 32px; overflow: hidden; position: relative;
        }
        /* è§†é¢‘/å›¾ç‰‡ç¼©ç•¥å›¾è¦†ç›– */
        .icon-thumb { width: 100%; height: 100%; object-fit: cover; }

        .icon-text {
            margin-top: 6px; font-size: 13px; color: white; text-align: center; 
            text-shadow: 0 1px 3px rgba(0,0,0,0.8); width: 100%; 
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding: 2px 4px;
        }

        /* ================= ç°ä»£åŒ–çª—å£ç³»ç»Ÿ ================= */
        .window {
            position: absolute; 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 10px; 
            box-shadow: var(--glass-shadow);
            display: flex; flex-direction: column; overflow: hidden; 
            min-width: 300px; min-height: 200px;
            opacity: 0; transform: scale(0.95); transition: opacity 0.2s, transform 0.2s, width 0.3s, height 0.3s, top 0.3s, left 0.3s;
        }
        .window.open { opacity: 1; transform: scale(1); }
        .window.minimized { 
            opacity: 0; transform: scale(0.5) translateY(500px); pointer-events: none; 
        }

        .win-header {
            height: var(--win-header-h); background: rgba(255,255,255,0.4); 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; cursor: move; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .win-title { font-weight: 600; font-size: 14px; color: #333; pointer-events: none;}
        
        /* Windows é£æ ¼æ§åˆ¶æŒ‰é’® */
        .win-controls { display: flex; gap: 0; height: 100%; align-items: center; }
        .win-btn { 
            width: 36px; height: 100%; border: none; background: transparent; 
            font-size: 14px; color: #555; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .win-btn:hover { background: rgba(0,0,0,0.1); }
        .btn-close:hover { background: #ff4d4f; color: white; }

        .win-body { flex: 1; position: relative; display: flex; overflow: hidden; background: rgba(255,255,255,0.8); }
        .win-content { flex: 1; padding: 0; overflow: auto; position: relative;}
        .win-iframe { width: 100%; height: 100%; border: none; background: white; }

        /* ================= ä»»åŠ¡æ  (Dock) ================= */
        #dock {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px; padding: 10px 15px; display: flex; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 9000;
        }
        .dock-item {
            width: 50px; height: 50px; background: rgba(255,255,255,0.85); border-radius: 14px;
            display: flex; align-items: center; justify-content: center; font-size: 26px; 
            cursor: pointer; transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative;
        }
        .dock-item:hover { transform: translateY(-10px) scale(1.15); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .dock-item::after {
            content: ''; position: absolute; bottom: -6px; width: 4px; height: 4px; 
            background: #333; border-radius: 50%; opacity: 0; transition: 0.3s;
        }
        .dock-item.running::after { opacity: 1; }

        /* ================= å³é”®èœå• & æ¨¡æ€æ¡† ================= */
        .context-menu {
            position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            width: 180px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            padding: 6px; display: none; z-index: 99999; border: 1px solid rgba(255,255,255,0.5);
            animation: fadeIn 0.1s ease;
        }
        .ctx-item {
            padding: 8px 12px; font-size: 13px; display: flex; align-items: center; gap: 10px;
            cursor: pointer; color: #333; border-radius: 6px;
        }
        .ctx-item:hover { background: var(--accent-color); color: white; }
        .ctx-sep { height: 1px; background: #eee; margin: 4px 0; }

        /* é€šç”¨è¾“å…¥æ¡†æ ·å¼ */
        .modern-input {
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; 
            border: 1px solid #ddd; background: rgba(255,255,255,0.8);
        }
        .modern-btn {
            width: 100%; padding: 10px; background: var(--accent-color); color: white; 
            border: none; border-radius: 6px; cursor: pointer; font-weight: 600;
        }
        .modern-btn:hover { filter: brightness(1.1); }

        /* åŠ è½½æ¡ */
        #progress-toast {
            position: fixed; top: 20px; right: 20px; width: 300px; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 10000; display: none; transform: translateX(120%); transition: 0.3s;
        }
        #progress-toast.show { transform: translateX(0); }

        @keyframes fadeIn { from { opacity:0; transform:scale(0.9); } to { opacity:1; transform:scale(1); } }
        
        /* ç™»å½•å± */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 100000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <div style="width: 80px; height: 80px; background: #333; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px;">
                <i class="fa-solid fa-cloud"></i>
            </div>
            <h2 style="margin-bottom: 20px; color: #333;">Welcome Back</h2>
            <input type="text" id="uid" class="modern-input" placeholder="ç”¨æˆ·å" value="admin">
            <input type="password" id="pwd" class="modern-input" placeholder="å¯†ç ">
            <button onclick="App.login()" class="modern-btn">ç™» å½•</button>
        </div>
    </div>

    <div id="desktop"><div class="icon-grid" id="desktop-grid"></div></div>

    <div id="dock">
        <div class="dock-item" onclick="App.refreshDesktop()" title="åˆ·æ–°">ğŸ”„</div>
        <div class="dock-item" onclick="App.createWindow('pc','æˆ‘çš„ç”µè„‘','folder','root')" title="æˆ‘çš„ç”µè„‘">ğŸ’»</div>
        <div style="width:1px; height:30px; background:rgba(0,0,0,0.2);"></div>
        <div class="dock-item" onclick="document.getElementById('folder-zip-input').click()" title="ä¸Šä¼ æ–‡ä»¶å¤¹ (è‡ªåŠ¨Zip)">ğŸ“¤</div>
        <div class="dock-item" onclick="App.toggleFullScreen()" title="å…¨å±æ¨¡å¼">â›¶</div>
    </div>

    <div id="ctx-menu" class="context-menu">
        <div class="ctx-item" onclick="App.openSelected()"><i class="fa-regular fa-folder-open"></i> æ‰“å¼€</div>
        <div class="ctx-sep"></div>
        <div class="ctx-item" onclick="App.renameSelected()"><i class="fa-solid fa-pen"></i> é‡å‘½å</div>
        <div class="ctx-item" onclick="App.deleteSelected()" style="color:#ff4d4f;"><i class="fa-solid fa-trash"></i> åˆ é™¤ / å¸è½½</div>
        <div class="ctx-sep"></div>
        <div class="ctx-item" onclick="App.createFolder()"><i class="fa-solid fa-folder-plus"></i> æ–°å»ºæ–‡ä»¶å¤¹</div>
        <div class="ctx-item" onclick="App.createSimpleLink('bilibili')"><i class="fa-brands fa-bilibili" style="color:#fb7299"></i> æ–°å»ºBç«™è§†é¢‘</div>
        <div class="ctx-item" onclick="App.createSimpleLink('wechat')"><i class="fa-brands fa-weixin" style="color:#07c160"></i> æ–°å»ºå…¬ä¼—å·æ–‡ç« </div>
        <div class="ctx-item" onclick="App.createSimpleLink('link')"><i class="fa-solid fa-link" style="color:#3498db"></i> æ–°å»ºé“¾æ¥</div>
        <div class="ctx-item" onclick="App.installH5AppSimple()"><i class="fa-solid fa-gamepad" style="color:#9b59b6"></i> å®‰è£…H5åº”ç”¨</div>
        <div class="ctx-sep"></div>
        <div class="ctx-item" onclick="App.changeWallpaper()"><i class="fa-solid fa-image"></i> åˆ‡æ¢å£çº¸</div>
    </div>

    <!-- é€šç”¨é“¾æ¥æ¨¡æ€æ¡† -->
    <div id="link-modal" class="window" style="display:none; width:400px; height:auto; top:20%; left:calc(50% - 200px); z-index:99999;">
        <div class="win-header">
            <div class="win-title" id="link-modal-title">æ–°å»ºé“¾æ¥</div>
            <div class="win-controls"><button class="win-btn btn-close" onclick="App.closeModal('link-modal')"><i class="fa-solid fa-xmark"></i></button></div>
        </div>
        <div style="padding:25px;">
            <div style="text-align:center; margin-bottom:20px; color: #666;">
                <i id="link-modal-icon" class="fa-solid fa-link fa-3x" style="color:#3498db"></i>
                <p style="font-size:12px; margin-top:10px;" id="link-modal-desc">æ·»åŠ è‡ªå®šä¹‰é“¾æ¥</p>
            </div>
            <input type="text" id="link-title" class="modern-input" placeholder="èµ„æºåç§°">
            <input type="text" id="link-url" class="modern-input" placeholder="é“¾æ¥åœ°å€ (https://...)">
            <input type="text" id="link-x" class="modern-input" placeholder="Xåæ ‡ (é»˜è®¤: 100)" value="100">
            <input type="text" id="link-y" class="modern-input" placeholder="Yåæ ‡ (é»˜è®¤: 100)" value="100">
            <input type="hidden" id="link-icon-class" value="fa-solid fa-link">
            <button onclick="App.submitLink()" class="modern-btn" style="margin-top:10px;">åˆ›å»º</button>
        </div>
    </div>

    <!-- H5åº”ç”¨å®‰è£…æ¨¡æ€æ¡† -->
    <div id="install-modal" class="window" style="display:none; width:380px; height:auto; top:20%; left:calc(50% - 190px); z-index:99999;">
        <div class="win-header">
            <div class="win-title">å®‰è£… H5 åº”ç”¨</div>
            <div class="win-controls"><button class="win-btn btn-close" onclick="App.closeModal('install-modal')"><i class="fa-solid fa-xmark"></i></button></div>
        </div>
        <div style="padding:25px;">
            <div style="text-align:center; margin-bottom:20px; color: #666;">
                <i class="fa-solid fa-gamepad fa-3x"></i>
                <p style="font-size:12px; margin-top:10px;">è¯·ä¸Šä¼ åŒ…å« index.html çš„ Zip åŒ…<br>æˆ–ä½¿ç”¨ Dock æ çš„æ–‡ä»¶å¤¹ä¸Šä¼ åŠŸèƒ½</p>
            </div>
            <input type="text" id="h5-name" class="modern-input" placeholder="åº”ç”¨åç§°">
            <input type="file" id="h5-file" accept=".zip" class="modern-input" style="padding: 5px;">
            <button onclick="App.installH5App()" class="modern-btn" style="margin-top:10px;">å¼€å§‹å®‰è£…</button>
        </div>
    </div>

    <input type="file" id="file-input" class="hidden-input" style="display:none" onchange="App.handleUpload(this)">
    <input type="file" id="folder-zip-input" style="display:none" webkitdirectory mozdirectory onchange="App.handleFolderAsZip(this)">

    <div id="progress-toast">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span id="prog-text" style="font-weight:bold; font-size:13px;">å¤„ç†ä¸­...</span>
            <span id="prog-percent" style="font-size:12px; color:#666;">0%</span>
        </div>
        <div style="width:100%; height:6px; background:#eee; border-radius:3px; overflow:hidden;">
            <div id="prog-bar" style="width:0%; height:100%; background:var(--accent-color); transition:0.2s;"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api'; 
        
        const App = {
            token: localStorage.getItem('token'),
            windows: [],
            zIndex: 100,
            desktopList: [],
            contextTarget: null,
            
            // æ‹–æ‹½ç›¸å…³
            isDragging: false, dragEl: null, dragStartX: 0, dragStartY: 0, lastClickX: 100, lastClickY: 100,

            init() {
                // å£çº¸åˆå§‹åŒ–
                this.changeWallpaper();

                if (this.token) {
                    this.refreshDesktop().catch(() => {
                        localStorage.removeItem('token');
                        document.getElementById('login-screen').style.display = 'flex';
                    });
                    document.getElementById('login-screen').style.display = 'none';
                }

                // å…¨å±€äº‹ä»¶
                document.addEventListener('mousedown', this.onDragStart.bind(this));
                document.addEventListener('mousemove', this.onDragMove.bind(this));
                document.addEventListener('mouseup', this.onDragEnd.bind(this));
                
                // å³é”®èœå•
                document.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    this.contextTarget = e.target.closest('.icon');
                    this.lastClickX = e.pageX; this.lastClickY = e.pageY; // è®°å½•ä½ç½®ä¾›æ–°å»ºä½¿ç”¨
                    const menu = document.getElementById('ctx-menu');
                    menu.style.display = 'block';
                    menu.style.left = Math.min(e.pageX, window.innerWidth - 180) + 'px';
                    menu.style.top = Math.min(e.pageY, window.innerHeight - 200) + 'px';
                });
                document.addEventListener('click', (e) => {
                    if(!e.target.closest('.context-menu')) document.getElementById('ctx-menu').style.display='none';
                });

                // å¤–éƒ¨æ–‡ä»¶æ‹–æ‹½
                document.addEventListener('dragover', e => e.preventDefault());
                document.addEventListener('drop', this.onExternalDrop.bind(this));
            },

            // --- è§†è§‰æ•ˆæœ ---
            changeWallpaper() {
                // ä½¿ç”¨ Unsplash æºï¼Œç§‘æŠ€/è‡ªç„¶ä¸»é¢˜
                const url = `https://images.unsplash.com/photo-1477346611705-65d1883cee1e?auto=format&fit=crop&w=1920&q=80`; 
                // ä½ ä¹Ÿå¯ä»¥æ”¹ç”¨éšæœºAPI: https://source.unsplash.com/random/1920x1080/?landscape
                document.body.style.backgroundImage = `url('${url}')`;
            },
            toggleFullScreen() {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else if (document.exitFullscreen) document.exitFullscreen();
            },

            // --- API åŸºç¡€ ---
            async req(url, method='GET', data=null, isFile=false) {
                const headers = { 'Authorization': `Bearer ${this.token}` };
                if (!isFile) headers['Content-Type'] = 'application/json';
                const opts = { method, headers };
                if (data) opts.body = isFile ? data : JSON.stringify(data);
                
                const res = await fetch(API_BASE + url, opts);
                if (res.status === 401) { location.reload(); throw new Error('Auth'); }
                if (!res.ok) throw new Error(`Error ${res.status}`);
                return method === 'DELETE' ? null : res.json();
            },

            // --- ç™»å½• ---
            async login() {
                const u = document.getElementById('uid').value;
                const p = document.getElementById('pwd').value;
                try {
                    const res = await fetch(API_BASE + '/token/', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: u, password: p })
                    });
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    this.token = data.access;
                    localStorage.setItem('token', this.token);
                    document.getElementById('login-screen').style.display = 'none';
                    this.refreshDesktop();
                } catch (e) { alert('ç™»å½•å¤±è´¥'); }
            },

            // --- æ¡Œé¢æ¸²æŸ“ ---
            async refreshDesktop() {
                const grid = document.getElementById('desktop-grid');
                grid.innerHTML = '';
                const data = await this.req('/desktop/?parent_id=root');
                this.desktopList = data.results || data || [];

                this.desktopList.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'icon';
                    el.dataset.id = item.id;
                    el.dataset.title = item.title;
                    el.ondblclick = () => this.openItem(item);
                    
                    // å›¾æ ‡å†…å®¹ç”Ÿæˆ
                    let iconInner = this.getIconHtml(item);
                    
                    // è§†é¢‘ç¼©ç•¥å›¾é€»è¾‘ (å¦‚æœæ–‡ä»¶æ˜¯è§†é¢‘ï¼Œä¸”æœ‰é“¾æ¥)
                    if(item.type === 'resource' && item.data.kind === 'video' && item.data.file) {
                        this.generateVideoThumbnail(item.data.file, el);
                    }

                    el.innerHTML = `
                        <div class="icon-body" id="icon-body-${item.id}">${iconInner}</div>
                        <div class="icon-text">${item.title}</div>
                    `;
                    grid.appendChild(el);
                });
            },

            getIconHtml(item) {
                if (item.type === 'category') return `<i class="fa-solid fa-folder" style="color:#f1c40f"></i>`;
                if (item.data.icon_class) return `<i class="${item.data.icon_class}" style="color:var(--accent-color)"></i>`;
                return `<i class="fa-solid fa-file" style="color:#aaa"></i>`;
            },

            // æå–è§†é¢‘é¦–å¸§
            generateVideoThumbnail(url, iconEl) {
                const video = document.createElement('video');
                video.src = url;
                video.crossOrigin = 'anonymous'; // å…³é”®ï¼šå…è®¸è·¨åŸŸæˆªå±
                video.currentTime = 1; // æˆªå–ç¬¬1ç§’
                video.onloadeddata = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                    const thumbUrl = canvas.toDataURL();
                    const body = iconEl.querySelector('.icon-body');
                    body.innerHTML = `<img src="${thumbUrl}" class="icon-thumb" style="border-radius:12px;">`;
                };
            },

            // --- çª—å£ç³»ç»Ÿ (Windows é£æ ¼) ---
            createWindow(id, title, type, content) {
                // å¦‚æœçª—å£å·²æœ€å°åŒ–ï¼Œæ¢å¤å®ƒ
                const exist = document.getElementById('win-' + id);
                if (exist) {
                    this.restoreWin(id);
                    return;
                }

                const win = document.createElement('div');
                win.className = 'window open';
                win.id = 'win-' + id;
                win.style.zIndex = ++this.zIndex;
                win.style.width = '800px'; win.style.height = '500px';
                win.style.left = '100px'; win.style.top = '80px';
                
                // ç‚¹å‡»ç½®é¡¶
                win.onmousedown = () => { win.style.zIndex = ++this.zIndex; };

                let bodyHtml = '';
                if (type === 'folder') {
                    bodyHtml = `<div class="win-content" id="content-${id}" style="padding:10px; display:flex; flex-wrap:wrap; align-content:flex-start;">åŠ è½½ä¸­...</div>`;
                } else if (type === 'iframe') {
                    bodyHtml = `<iframe src="${content}" class="win-iframe"></iframe>`;
                } else {
                    bodyHtml = `<div class="win-content" style="padding:20px; background:white;">${content}</div>`;
                }

                // Windows æ ‡å‡†æŒ‰é’®å¸ƒå±€: æœ€å°åŒ–(_) æœ€å¤§åŒ–(â–¡) å…³é—­(X)
                win.innerHTML = `
                    <div class="win-header" onmousedown="App.dragWin(event, '${id}')">
                        <div class="win-title">${title}</div>
                        <div class="win-controls">
                            <button class="win-btn" onclick="App.minWin('${id}')" title="æœ€å°åŒ–"><i class="fa-solid fa-minus"></i></button>
                            <button class="win-btn" onclick="App.maxWin('${id}')" title="æœ€å¤§åŒ–"><i class="fa-regular fa-square"></i></button>
                            <button class="win-btn btn-close" onclick="App.closeWin('${id}')" title="å…³é—­"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                    <div class="win-body">${bodyHtml}</div>
                `;
                
                document.body.appendChild(win);
                this.windows.push({id, el: win});
                this.updateDock(id, true); // æ·»åŠ åˆ° Dock
                
                if (type === 'folder') this.loadFolder(content, 'win-'+id);
            },

            // çª—å£æ§åˆ¶é€»è¾‘
            closeWin(id) {
                document.getElementById('win-' + id)?.remove();
                this.windows = this.windows.filter(w => w.id !== id);
                this.updateDock(id, false); // ä» Dock ç§»é™¤æŒ‡ç¤ºå™¨
            },
            minWin(id) {
                const win = document.getElementById('win-' + id);
                win.classList.add('minimized');
                win.classList.remove('open');
            },
            restoreWin(id) {
                const win = document.getElementById('win-' + id);
                win.classList.remove('minimized');
                win.classList.add('open');
                win.style.zIndex = ++this.zIndex;
            },
            maxWin(id) {
                const win = document.getElementById('win-' + id);
                if (win.dataset.maximized === 'true') {
                    // è¿˜åŸ
                    win.style.width = '800px'; win.style.height = '500px'; 
                    win.style.left = '100px'; win.style.top = '80px';
                    win.style.borderRadius = '10px';
                    win.dataset.maximized = 'false';
                } else {
                    // å…¨å±
                    win.style.width = '100%'; win.style.height = 'calc(100% - 70px)'; // ç•™å‡ºä»»åŠ¡æ 
                    win.style.left = '0'; win.style.top = '0';
                    win.style.borderRadius = '0';
                    win.dataset.maximized = 'true';
                }
            },
            // ç®€å•çš„ä»»åŠ¡æ çŠ¶æ€æ›´æ–° (ç¤ºä¾‹)
            updateDock(id, isOpen) {
                // å®é™…é¡¹ç›®ä¸­å¯ä»¥åŠ¨æ€åˆ›å»º Dock å›¾æ ‡ï¼Œè¿™é‡Œç®€å•å¤„ç†
                console.log(`Window ${id} state: ${isOpen}`);
            },

            // --- æ ¸å¿ƒåŠŸèƒ½ ---
            
            // 1. æ‰“å¼€é€»è¾‘ (æ”¯æŒ H5 åº”ç”¨å’Œæ™®é€šæ–‡ä»¶)
            openItem(item) {
                if (item.type === 'category') {
                    this.createWindow(item.id, item.title, 'folder', item.id);
                } else if (item.type === 'resource') {
                    const link = item.data.link || item.data.file;
                    if (!link) return;
                    
                    // å¦‚æœæ˜¯ H5 åº”ç”¨ (æ ¹æ®è·¯å¾„åˆ¤æ–­)
                    if (item.data.kind === 'link' && link.includes('/h5apps/')) {
                         window.open(link, item.title, "width=1280,height=720");
                         return;
                    }

                    const ext = link.split('.').pop().toLowerCase();
                    // è§†é¢‘/PDF/å›¾ç‰‡ -> Iframe
                    if (['mp4','pdf','png','jpg','html'].includes(ext)) {
                        this.createWindow('res-'+item.id, item.title, 'iframe', link);
                    } 
                    // Office -> é¢„è§ˆ
                    else if (['docx'].includes(ext)) this.previewDocx(item.title, link);
                    else if (['xlsx'].includes(ext)) this.previewExcel(item.title, link);
                    else window.open(link, '_blank');
                }
            },

            // 1. æ–‡ä»¶ä¸Šä¼ 
            async handleUpload(input) {
                const files = input.files;
                if (!files.length) return;

                this.showProgress(true, 0, 'ä¸Šä¼ ä¸­...');

                try {
                    for(let i=0; i<files.length; i++) {
                        const fd = new FormData();
                        fd.append('file', files[i]);
                        fd.append('parent_id', 'root');
                        fd.append('x', this.lastClickX);
                        fd.append('y', this.lastClickY);

                        try {
                            await this.req('/desktop/upload_file/', 'POST', fd, true);
                        } catch(e) {
                            console.error('ä¸Šä¼ å¤±è´¥', e);
                        }

                        this.showProgress(true, Math.round(((i+1)/files.length)*100), `ä¸Šä¼  ${i+1}/${files.length}`);
                    }
                    setTimeout(() => { this.showProgress(false); this.refreshDesktop(); }, 500);
                } catch(e) {
                    alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
                    this.showProgress(false);
                }
            },

            // 2. æ–‡ä»¶å¤¹/ZIP å¤„ç† (å‰ç«¯å‹ç¼©æ–‡ä»¶å¤¹)
            async handleFolderAsZip(input) {
                const files = input.files;
                if (!files.length) return;

                this.showProgress(true, 0, 'æ­£åœ¨å‹ç¼©æ–‡ä»¶å¤¹...');
                
                const zip = new JSZip();
                // ä¿æŒæ–‡ä»¶å¤¹ç»“æ„
                for (let file of files) {
                    // webkitRelativePath ä¾‹å¦‚: "MyGame/css/style.css"
                    zip.file(file.webkitRelativePath, file);
                }

                // ç”Ÿæˆ Zip Blob
                const content = await zip.generateAsync({type:"blob"}, (meta) => {
                    this.showProgress(true, Math.round(meta.percent), 'æ­£åœ¨å‹ç¼©...');
                });

                // æ„é€ è¡¨å•ä¸Šä¼ 
                const fd = new FormData();
                const folderName = files[0].webkitRelativePath.split('/')[0];
                fd.append('file', content, folderName + '.zip'); // ä¼ªè£…æˆ zip æ–‡ä»¶
                fd.append('title', folderName);
                fd.append('icon_class', 'fa-solid fa-folder-tree'); // é»˜è®¤å›¾æ ‡
                
                // ä¸Šä¼ åˆ°åç«¯ install_h5_app æ¥å£ (åç«¯ä¼šè‡ªåŠ¨è§£å‹)
                this.showProgress(true, 50, 'æ­£åœ¨ä¸Šä¼ ...');
                try {
                    await this.req('/desktop/install_h5_app/', 'POST', fd, true);
                    this.showProgress(true, 100, 'å®Œæˆ!');
                    setTimeout(() => { this.showProgress(false); this.refreshDesktop(); }, 1000);
                } catch(e) {
                    alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
                    this.showProgress(false);
                }
            },

            // 3. æ–°å»ºæ–‡ä»¶å¤¹ (çœŸå®è°ƒç”¨)
            async createFolder() {
                const name = prompt("è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°", "æ–°å»ºæ–‡ä»¶å¤¹");
                if (!name) return;
                await this.req('/desktop/create_folder/', 'POST', {
                    name: name, parent_id: 'root', x: this.lastClickX, y: this.lastClickY
                });
                this.refreshDesktop();
            },

            // --- è¾…åŠ©åŠŸèƒ½ ---
            loadFolder: async function(pid, winId) {
                const container = document.getElementById(`content-${winId.replace('win-','')}`);
                const data = await this.req(`/desktop/?parent_id=${pid}`);
                const list = data.results || [];
                container.innerHTML = '';
                list.forEach(item => {
                    const d = document.createElement('div');
                    d.className = 'icon'; d.style.margin='5px';
                    d.innerHTML = `<div class="icon-body" style="font-size:24px; width:50px; height:50px;">${this.getIconHtml(item)}</div><div class="icon-text" style="color:#333; text-shadow:none;">${item.title}</div>`;
                    d.ondblclick = () => this.openItem(item);
                    container.appendChild(d);
                });
            },
            
            previewDocx: async function(title, url) {
                this.createWindow('docx'+Date.now(), title, 'html', '<div id="doc-v">åŠ è½½ä¸­...</div>');
                const buf = await (await fetch(url)).arrayBuffer();
                const res = await mammoth.convertToHtml({arrayBuffer: buf});
                document.getElementById('doc-v').innerHTML = `<div style="padding:20px; line-height:1.6;">${res.value}</div>`;
            },

            // æ‹–æ‹½çª—å£
            dragWin(e, id) {
                const win = document.getElementById('win-' + id);
                win.style.zIndex = ++this.zIndex;
                if(win.dataset.maximized === 'true') return; // å…¨å±ä¸å¯æ‹–æ‹½

                let startX = e.clientX, startY = e.clientY;
                let startLeft = win.offsetLeft, startTop = win.offsetTop;
                
                const move = (ev) => {
                    win.style.left = startLeft + (ev.clientX - startX) + 'px';
                    win.style.top = startTop + (ev.clientY - startY) + 'px';
                };
                const stop = () => {
                    document.removeEventListener('mousemove', move);
                    document.removeEventListener('mouseup', stop);
                };
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', stop);
            },
            
            // æ‹–æ‹½å›¾æ ‡
            onDragStart(e) {
                const icon = e.target.closest('.icon');
                if(!icon || e.target.closest('.window')) return;
                this.isDragging = true; this.dragEl = icon;
                this.dragStartX = e.clientX; this.dragStartY = e.clientY;
            },
            onDragMove(e) {
                if(!this.isDragging || !this.dragEl) return;
                const dx = e.clientX - this.dragStartX;
                const dy = e.clientY - this.dragStartY;
                this.dragEl.style.transform = `translate(${dx}px, ${dy}px)`;
            },
            onDragEnd(e) {
                if(this.dragEl) {
                    // æ£€æµ‹æ˜¯å¦æ‹–æ”¾åˆ°äº†æ–‡ä»¶å¤¹ä¸Š
                    const draggedIconId = this.dragEl.dataset.id;
                    const draggedItem = this.desktopList.find(i => i.id == draggedIconId);
                    
                    // è·å–é¼ æ ‡ä½ç½®ä¸‹çš„å…ƒç´ 
                    const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
                    const folderEl = elementBelow ? elementBelow.closest('.icon') : null;
                    
                    if (folderEl && folderEl !== this.dragEl) {
                        const folderIconId = folderEl.dataset.id;
                        const folderItem = this.desktopList.find(i => i.id == folderIconId);
                        
                        // å¦‚æœç›®æ ‡æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œç§»åŠ¨æ“ä½œ
                        if (folderItem && folderItem.type === 'category') {
                            // å°†æ–‡ä»¶ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹
                            this.moveToFolder(draggedIconId, folderIconId);
                        }
                    }
                    
                    this.dragEl.style.transform = 'none';
                    this.isDragging = false; 
                    this.dragEl = null;
                }
            },
            
            // å¤–éƒ¨æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ 
            async onExternalDrop(e) {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (!files.length) return;

                const dropX = e.clientX || this.lastClickX;
                const dropY = e.clientY || this.lastClickY;

                this.showProgress(true, 0, 'ä¸Šä¼ ä¸­...');
                
                try {
                    for(let i=0; i<files.length; i++) {
                        const fd = new FormData();
                        fd.append('file', files[i]);
                        fd.append('parent_id', 'root');
                        fd.append('x', dropX); 
                        fd.append('y', dropY);
                        
                        try {
                            await this.req('/desktop/upload_file/', 'POST', fd, true);
                        } catch(e) {
                            console.error('ä¸Šä¼ å¤±è´¥', e);
                        }
                        
                        this.showProgress(true, Math.round(((i+1)/files.length)*100), `ä¸Šä¼  ${i+1}/${files.length}`);
                    }
                    setTimeout(() => { this.showProgress(false); this.refreshDesktop(); }, 500);
                } catch(e) {
                    alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
                    this.showProgress(false);
                }
            },
            
            showProgress(show, percent=0, text='') {
                const el = document.getElementById('progress-toast');
                el.className = show ? 'show' : '';
                if(show) {
                    document.getElementById('prog-bar').style.width = percent + '%';
                    document.getElementById('prog-percent').innerText = percent + '%';
                    document.getElementById('prog-text').innerText = text;
                }
            },

            // ç®€åŒ–ç‰ˆ - åˆ›å»ºé“¾æ¥ï¼ˆç”¨promptï¼‰
            async createSimpleLink(type) {
                document.getElementById('ctx-menu').style.display = 'none';

                let title = '';
                let link = '';
                let icon = '';

                if (type === 'bilibili') {
                    title = prompt('è¯·è¾“å…¥Bç«™è§†é¢‘åç§°', 'Bç«™è§†é¢‘');
                    if (!title) return;
                    link = prompt('è¯·è¾“å…¥Bç«™è§†é¢‘é“¾æ¥', 'https://www.bilibili.com/video/');
                    if (!link) return;
                    icon = 'fa-brands fa-bilibili';
                } else if (type === 'wechat') {
                    title = prompt('è¯·è¾“å…¥å…¬ä¼—å·æ–‡ç« æ ‡é¢˜', 'å…¬ä¼—å·æ–‡ç« ');
                    if (!title) return;
                    link = prompt('è¯·è¾“å…¥å…¬ä¼—å·æ–‡ç« é“¾æ¥', 'https://mp.weixin.qq.com/');
                    if (!link) return;
                    icon = 'fa-brands fa-weixin';
                } else {
                    title = prompt('è¯·è¾“å…¥èµ„æºåç§°', 'è‡ªå®šä¹‰é“¾æ¥');
                    if (!title) return;
                    link = prompt('è¯·è¾“å…¥é“¾æ¥åœ°å€', 'https://');
                    if (!link) return;
                    icon = 'fa-solid fa-link';
                }

                try {
                    await this.req('/desktop/create_link/', 'POST', {
                        title, 
                        link, 
                        icon_class: icon, 
                        x: this.lastClickX, 
                        y: this.lastClickY,
                        parent_id: 'root'
                    });
                    this.refreshDesktop();
                } catch(e) {
                    alert('åˆ›å»ºå¤±è´¥: ' + e.message);
                }
            },

            // ç®€åŒ–ç‰ˆ - å®‰è£…H5åº”ç”¨ï¼ˆç”¨promptï¼Œæ”¯æŒä¸Šä¼ æ–‡ä»¶å¤¹è‡ªåŠ¨æ‰“åŒ…ï¼‰
            async installH5AppSimple() {
                document.getElementById('ctx-menu').style.display = 'none';

                const name = prompt('è¯·è¾“å…¥åº”ç”¨åç§°', 'æˆ‘çš„åº”ç”¨');
                if (!name) return;

                // è§¦å‘æ–‡ä»¶å¤¹é€‰æ‹©
                const folderInput = document.createElement('input');
                folderInput.type = 'file';
                folderInput.webkitdirectory = true;
                folderInput.mozdirectory = true;
                folderInput.style.display = 'none';

                folderInput.onchange = async (e) => {
                    const files = e.target.files;
                    if (!files.length) return;

                    // æç¤ºæ­£åœ¨å¤„ç†
                    alert('æ­£åœ¨æ‰“åŒ…æ–‡ä»¶å¤¹ï¼Œè¯·ç¨å€™...');

                    try {
                        // ä½¿ç”¨JSZipæ‰“åŒ…æ–‡ä»¶å¤¹
                        const zip = new JSZip();
                        const folderName = files[0].webkitRelativePath.split('/')[0] || name;

                        // éå†æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            const relativePath = file.webkitRelativePath || file.name;

                            // è¯»å–æ–‡ä»¶å†…å®¹
                            const fileContent = await file.arrayBuffer();
                            zip.file(relativePath, fileContent);
                        }

                        this.showProgress(true, 50, 'æ­£åœ¨æ‰“åŒ…...');

                        // ç”Ÿæˆzipæ–‡ä»¶
                        const zipBlob = await zip.generateAsync({type: 'blob'});

                        // åˆ›å»ºFormDataä¸Šä¼ 
                        const fd = new FormData();
                        fd.append('title', name);
                        fd.append('file', zipBlob, `${folderName}.zip`);
                        fd.append('icon_class', 'fa-solid fa-gamepad');

                        this.showProgress(true, 70, 'æ­£åœ¨ä¸Šä¼ ...');

                        // ä¸Šä¼ åˆ°æœåŠ¡å™¨
                        await this.req('/desktop/install_h5_app/', 'POST', fd, true);
                        this.showProgress(true, 100, 'å®‰è£…æˆåŠŸ');
                        setTimeout(() => { this.showProgress(false); this.refreshDesktop(); }, 1000);

                    } catch(e) {
                        console.error('æ‰“åŒ…å¤±è´¥:', e);
                        alert('æ‰“åŒ…å¤±è´¥: ' + e.message);
                        this.showProgress(false);
                    }
                };

                folderInput.click();
            },

            async submitLink() {
                const title = document.getElementById('link-title').value;
                const link = document.getElementById('link-url').value;
                const icon = document.getElementById('link-icon-class').value;
                const x = parseInt(document.getElementById('link-x').value) || 100;
                const y = parseInt(document.getElementById('link-y').value) || 100;
                
                if (!title || !link) {
                    alert('è¯·å¡«å†™å®Œæ•´çš„èµ„æºåç§°å’Œé“¾æ¥åœ°å€');
                    return;
                }
                
                try {
                    await this.req('/desktop/create_link/', 'POST', {
                        title, 
                        link, 
                        icon_class: icon, 
                        x, 
                        y,
                        parent_id: 'root'
                    });
                    this.closeModal('link-modal');
                    this.refreshDesktop();
                } catch(e) {
                    alert('åˆ›å»ºå¤±è´¥: ' + e.message);
                }
            },
            
            // H5åº”ç”¨å®‰è£…
            showInstallModal() {
                document.getElementById('ctx-menu').style.display = 'none';
                document.getElementById('install-modal').style.display = 'block';
            },
            
            async installH5App() {
                const name = document.getElementById('h5-name').value;
                const file = document.getElementById('h5-file').files[0];
                if (!name || !file) return alert('è¯·å¡«å†™åç§°å¹¶é€‰æ‹©ZIPæ–‡ä»¶');

                const fd = new FormData();
                fd.append('title', name);
                fd.append('file', file);
                fd.append('icon_class', 'fa-solid fa-gamepad');

                this.showProgress(true, 10, 'æ­£åœ¨å®‰è£…...');
                try {
                    await this.req('/desktop/install_h5_app/', 'POST', fd, true);
                    this.showProgress(true, 100, 'å®‰è£…æˆåŠŸ');
                    this.closeModal('install-modal');
                    setTimeout(() => { this.showProgress(false); this.refreshDesktop(); }, 1000);
                } catch(e) {
                    alert('å®‰è£…å¤±è´¥');
                    this.showProgress(false);
                }
            },
            
            async moveToFolder(fileId, folderId) {
                try {
                    // è·å–ç›®æ ‡æ–‡ä»¶å¤¹çš„çœŸå® ID
                    let targetParentId = null;

                    const folderIcon = this.desktopList.find(i => i.id == folderId);
                    if (folderIcon && folderIcon.type === 'category') {
                        targetParentId = folderIcon.data.id || folderIcon.id;
                    } else {
                        return;
                    }

                    // å‘é€è¯·æ±‚
                    await this.req(`/desktop/${fileId}/move/`, 'PATCH', { parent_id: targetParentId });

                    // åˆ·æ–° UI
                    this.refreshDesktop();

                    // æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å¼€çš„ç›®æ ‡æ–‡ä»¶å¤¹çª—å£ï¼Œå¦‚æœæœ‰ï¼Œä¹Ÿåˆ·æ–°å®ƒ
                    this.windows.forEach(winObj => {
                        const contentDiv = winObj.el.querySelector('.win-content');
                        if(contentDiv && contentDiv.dataset.currentFolder == targetParentId) {
                            this.loadFolder(targetParentId, winObj.id);
                        }
                    });

                } catch(e) {
                    alert("ç§»åŠ¨å¤±è´¥: " + e.message);
                    this.refreshDesktop();
                }
            },
            
            async deleteSelected() {
                if (!this.contextTarget) return;
                
                const itemId = this.contextTarget.dataset.id;
                const item = this.desktopList.find(i => i.id == itemId);
                
                if (!item) {
                    document.getElementById('ctx-menu').style.display = 'none';
                    return;
                }
                
                const itemType = item.type === 'category' ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶';
                
                if (confirm(`ç¡®å®šåˆ é™¤ ${itemType} "${item.title}" å—ï¼Ÿ`)) {
                    try {
                        await this.req(`/desktop/${itemId}/uninstall/`, 'DELETE');
                        this.refreshDesktop();
                    } catch(e) {
                        alert(`åˆ é™¤å¤±è´¥: ${e.message}`);
                    }
                }
                document.getElementById('ctx-menu').style.display = 'none';
            },
            
            closeModal(id) { document.getElementById(id).style.display='none'; }
        };

        App.init();
    </script>
    
    <!-- JWT è®¤è¯ç®¡ç† -->
    <script>
        const API_BASE = '/api';
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            
            if (!token || !refreshToken) {
                showLoginPrompt();
                return false;
            }
            
            return true;
        }
        
        // æ˜¾ç¤ºç™»å½•æç¤º
        function showLoginPrompt() {
            const overlay = document.createElement('div');
            overlay.className = 'login-overlay';
            overlay.innerHTML = `
                <div class="login-prompt">
                    <h3>è¯·å…ˆç™»å½•</h3>
                    <p>æ‚¨éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®æ¡Œé¢ç³»ç»Ÿ</p>
                    <button class="login-btn" onclick="goToLogin()">å‰å¾€ç™»å½•</button>
                    <button class="login-btn" onclick="tryGuestMode()" style="background: #666;">è®¿å®¢æ¨¡å¼</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        // è·³è½¬åˆ°ç™»å½•é¡µé¢
        function goToLogin() {
            window.location.href = '/login.html';
        }
        
        // å°è¯•è®¿å®¢æ¨¡å¼
        function tryGuestMode() {
            // å°è¯•ä½¿ç”¨é»˜è®¤è´¦æˆ·ç™»å½•
            attemptGuestLogin();
        }
        
        // å°è¯•è®¿å®¢ç™»å½•
        async function attemptGuestLogin() {
            try {
                const response = await fetch(`${API_BASE}/token/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'guest',
                        password: 'guest123'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    location.reload();
                } else {
                    alert('è®¿å®¢è´¦æˆ·ä¸å¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åˆ›å»ºè´¦æˆ·');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
            }
        }
        
        // åˆ·æ–°token
        async function refreshToken() {
            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) return false;
            
            try {
                const response = await fetch(`${API_BASE}/token/refresh/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ refresh: refreshToken })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    return true;
                }
            } catch (error) {
                console.error('Token refresh failed:', error);
            }
            return false;
        }
        
        // è·å–è®¤è¯å¤´
        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        // ä¿®æ”¹APIè¯·æ±‚å‡½æ•°ï¼Œæ·»åŠ è®¤è¯
        function createAuthenticatedAPI() {
            const originalReq = window.req;
            
            window.req = async function(url, method = 'GET', data = null) {
                // æ£€æŸ¥è®¤è¯
                if (!checkAuth()) {
                    throw new Error('æœªè®¤è¯');
                }
                
                const headers = getAuthHeaders();
                
                try {
                    const response = await fetch(API_BASE + url, {
                        method: method,
                        headers: headers,
                        body: data ? JSON.stringify(data) : null
                    });
                    
                    // å¦‚æœæ˜¯401é”™è¯¯ï¼Œå°è¯•åˆ·æ–°token
                    if (response.status === 401) {
                        const refreshed = await refreshToken();
                        if (refreshed) {
                            // é‡æ–°å‘é€è¯·æ±‚
                            return await window.req(url, method, data);
                        } else {
                            // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•
                            goToLogin();
                            return null;
                        }
                    }
                    
                    return response;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            };
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAuth()) {
                createAuthenticatedAPI();
            }
        });
        
        // æ·»åŠ ç™»å‡ºåŠŸèƒ½
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            location.reload();
        }
        
        // åœ¨ä»»åŠ¡æ æ·»åŠ ç”¨æˆ·ä¿¡æ¯
        function addUserInfoToTaskbar() {
            const taskbar = document.querySelector('.taskbar');
            if (taskbar) {
                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';
                userInfo.innerHTML = `
                    <span style="color: white; margin-right: 10px;">ç”¨æˆ·: ${getUsername() || 'Guest'}</span>
                    <button onclick="logout()" style="background: transparent; border: 1px solid white; color: white; padding: 2px 8px; border-radius: 3px; cursor: pointer;">ç™»å‡º</button>
                `;
                taskbar.appendChild(userInfo);
            }
        }
        
        // è·å–ç”¨æˆ·åï¼ˆç®€åŒ–ç‰ˆï¼‰
        function getUsername() {
            // å¯ä»¥ä»tokenè§£ç æˆ–ä»APIè·å–
            return 'ç”¨æˆ·';
        }
        
        // åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢
        if (checkAuth()) {
            document.addEventListener('DOMContentLoaded', function() {
                addUserInfoToTaskbar();
            });
        }
    </script>
</body>
</html>